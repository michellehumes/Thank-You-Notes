<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thank You Notes Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }

        .stat-card.envelopes .number { color: #667eea; }
        .stat-card.written .number { color: #f59e0b; }
        .stat-card.sent .number { color: #10b981; }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filters input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .filters input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filters button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: auto;
            max-height: 70vh;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            z-index: 10;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            cursor: pointer;
        }

        th:hover {
            background: #f1f5f9;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr.completed {
            background: #f0fdf4;
        }

        .guest-name {
            font-weight: 600;
            color: #1f2937;
        }

        .address {
            font-size: 12px;
            color: #6b7280;
            max-width: 200px;
        }

        .gift {
            font-size: 13px;
            color: #4b5563;
            max-width: 250px;
        }

        .value {
            font-weight: 600;
            color: #059669;
        }

        .ty-preview {
            font-size: 11px;
            color: #9ca3af;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .ty-preview:hover {
            color: #667eea;
        }

        .checkbox-cell {
            text-align: center;
        }

        .checkbox-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-wrapper label {
            font-size: 10px;
            color: #9ca3af;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #1f2937;
        }

        .ty-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .ty-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-content button {
            padding: 10px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .no-gift {
            color: #9ca3af;
            font-style: italic;
        }

        .export-section {
            margin-top: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .save-indicator {
            color: #10b981;
            font-size: 14px;
            padding: 8px 15px;
            background: #f0fdf4;
            border-radius: 20px;
            border: 1px solid #10b981;
        }

        .save-indicator.saving {
            color: #f59e0b;
            background: #fffbeb;
            border-color: #f59e0b;
        }

        .save-indicator.syncing {
            color: #3b82f6;
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .save-indicator.error {
            color: #ef4444;
            background: #fef2f2;
            border-color: #ef4444;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }

        .setup-banner {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: #92400e;
        }

        .setup-banner h3 {
            margin: 0 0 10px 0;
            color: #92400e;
        }

        .setup-banner code {
            background: #fde68a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .editable {
            cursor: text;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 50px;
            min-height: 20px;
            display: inline-block;
        }

        .editable:hover {
            background: #e5e7eb;
        }

        .editable:focus {
            outline: 2px solid #667eea;
            background: white;
        }

        .editable.empty:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }

        .editable:focus::before {
            content: '';
        }

        .relation-select {
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            cursor: pointer;
        }

        .relation-bride { color: #ec4899; }
        .relation-groom { color: #3b82f6; }
        .relation-joint { color: #6b7280; }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 1000px;
            }
        }
    </style>
</head>
<body>
    <script>
        // Password protection
        const correctPassword = "wedding2025";
        const enteredPassword = sessionStorage.getItem('dashboardPassword');

        if (enteredPassword !== correctPassword) {
            const password = prompt("Enter password to access the dashboard:");
            if (password === correctPassword) {
                sessionStorage.setItem('dashboardPassword', password);
            } else {
                alert("Incorrect password!");
                window.location.href = "about:blank";
            }
        }
    </script>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">Syncing data...</div>
    </div>

    <div class="container">
        <!-- Setup banner (shown if Supabase not configured) -->
        <div id="setupBanner" class="setup-banner" style="display: none;">
            <h3>Setup Required for Shared Access</h3>
            <p>To enable syncing between you and your partner, you need to configure Supabase. See the setup instructions below the tracker.</p>
        </div>

        <h1>Thank You Notes Tracker</h1>
        <p class="subtitle">Michelle & Gray's Wedding Gift Tracker</p>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Guests</h3>
                <div class="number" id="totalGuests">0</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #8b5cf6;">
                <h3>Gifts Received</h3>
                <div class="number" style="color: #8b5cf6;" id="giftsReceived">0</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #ef4444;">
                <h3>TY Notes Remaining</h3>
                <div class="number" style="color: #ef4444;" id="notesRemaining">0</div>
            </div>
            <div class="stat-card envelopes">
                <h3>Envelopes Created</h3>
                <div class="number" id="envelopesCreated">0</div>
                <div class="progress-bar"><div class="fill" id="envelopeProgress" style="background: #667eea; width: 0%"></div></div>
            </div>
            <div class="stat-card written">
                <h3>Notes Written</h3>
                <div class="number" id="notesWritten">0</div>
                <div class="progress-bar"><div class="fill" id="writtenProgress" style="background: #f59e0b; width: 0%"></div></div>
            </div>
            <div class="stat-card sent">
                <h3>Notes Sent</h3>
                <div class="number" id="notesSent">0</div>
                <div class="progress-bar"><div class="fill" id="sentProgress" style="background: #10b981; width: 0%"></div></div>
            </div>
        </div>

        <div class="filters">
            <input type="text" id="searchInput" placeholder="Search guests, gifts, addresses...">
            <select id="filterStatus">
                <option value="all">All Guests</option>
                <option value="needs-envelope">Needs Envelope</option>
                <option value="needs-writing">Needs Writing</option>
                <option value="needs-sending">Needs Sending</option>
                <option value="completed">Completed</option>
                <option value="has-gift">Has Gift</option>
                <option value="no-gift">No Gift</option>
            </select>
            <select id="filterRelation">
                <option value="all">All Relations</option>
                <option value="joint">Joint</option>
                <option value="bride">Bride</option>
                <option value="groom">Groom</option>
            </select>
            <button class="btn-secondary" onclick="resetFilters()">Reset</button>
            <button class="btn-primary" onclick="addNewGuest()">+ Add Guest</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('name')">Guest Name</th>
                        <th onclick="sortTable('address')">Address</th>
                        <th onclick="sortTable('relation')">Relation</th>
                        <th onclick="sortTable('gift')">Gift</th>
                        <th onclick="sortTable('value')">Value</th>
                        <th>TY Note</th>
                        <th onclick="sortTable('envelope')">Envelope</th>
                        <th onclick="sortTable('written')">Written</th>
                        <th onclick="sortTable('sent')">Sent</th>
                        <th onclick="sortTable('xmasCard')">Xmas Card</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="export-section">
            <span id="saveIndicator" class="save-indicator">All changes saved locally</span>
            <button class="btn-primary" onclick="manualSave()" style="background: #10b981;">Save Now</button>
            <button class="btn-primary" onclick="exportProgress()">Download CSV</button>
            <button class="btn-secondary" onclick="markAllEnvelopes()">Mark All Envelopes Done</button>
            <button class="btn-secondary" onclick="clearAllProgress()">Clear All Progress</button>
        </div>

        <!-- Setup Instructions (shown when Supabase not configured) -->
        <div id="setupInstructions" class="setup-banner" style="margin-top: 30px;">
            <h3>Setup Instructions for Shared Access</h3>
            <p>To share this tracker with your partner so both of you can make changes that sync:</p>
            <ol style="margin: 15px 0; padding-left: 20px;">
                <li><strong>Create a free Supabase account:</strong> Go to <a href="https://supabase.com" target="_blank">supabase.com</a> and sign up</li>
                <li><strong>Create a new project</strong> (choose any name and password)</li>
                <li><strong>Go to Table Editor</strong> and create a new table called <code>wedding_tracker</code> with these columns:
                    <ul style="margin: 10px 0;">
                        <li><code>id</code> (text, primary key)</li>
                        <li><code>progress</code> (jsonb)</li>
                        <li><code>edits</code> (jsonb)</li>
                        <li><code>deletions</code> (jsonb)</li>
                        <li><code>updated_at</code> (timestamptz)</li>
                    </ul>
                </li>
                <li><strong>Go to Project Settings → API</strong> and copy your Project URL and anon/public key</li>
                <li><strong>Update this file:</strong> Edit the SUPABASE_URL and SUPABASE_KEY values at the top of the script section</li>
                <li><strong>Enable Row Level Security:</strong> Go to Authentication → Policies and enable RLS on the wedding_tracker table, then add a policy to allow all operations</li>
            </ol>
            <p><strong>Quick SQL Setup:</strong> In the SQL Editor, run this:</p>
            <pre style="background: #fde68a; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">
CREATE TABLE wedding_tracker (
    id TEXT PRIMARY KEY,
    progress JSONB DEFAULT '{}',
    edits JSONB DEFAULT '{}',
    deletions JSONB DEFAULT '[]',
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE wedding_tracker ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow all" ON wedding_tracker FOR ALL USING (true) WITH CHECK (true);</pre>
        </div>
    </div>

    <div class="modal" id="tyModal">
        <div class="modal-content">
            <h2 id="modalGuestName">Thank You Note</h2>
            <textarea id="modalTyText" class="ty-textarea" placeholder="Write your thank you note here..."></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveTyNote()" style="background: #10b981;">Save</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // SUPABASE CONFIGURATION - Update these values!
        // =============================================
        const SUPABASE_URL = 'https://wllgsnhlzduwehxxwdpt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbGdzbmhsemR1d2VoeHh3ZHB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzM0NjYsImV4cCI6MjA4MDY0OTQ2Nn0.s1QssScNjYw2BezCCzLrO2BSoaioHcja7uYHR_5gdEw';

        // Initialize Supabase client (if configured)
        let supabase = null;
        let syncEnabled = false;

        try {
            if (SUPABASE_URL && SUPABASE_KEY && window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                syncEnabled = true;
            }
        } catch (e) {
            console.log('Supabase not available, using local storage only');
        }

        // Gift data from CSV
        let giftData = [
            {"name": "Jean Marie Woodard & Kenneth Munnelly", "address": "542 Westchester Place SW, Ocean Isle Beach, NC 28469", "relation": "bride", "gift": "Cuisinart Precision Stand Mixer; Check", "value": 1319.95, "ty": ""},
            {"name": "Kristen Munnelly", "address": "105 Steeplewood Dr, Exton, PA 19341", "relation": "bride", "gift": "Wüsthof 16-Piece Knife Block Set; Check", "value": 1495, "ty": ""},
            {"name": "Randall & Lisa King", "address": "310 American Way, Gibsonia, PA 15044", "relation": "bride", "gift": "Bash Beverage Tub; Check", "value": 469.95, "ty": ""},
            {"name": "Jan Van Dam", "address": "9 Sextant Lane, Scarborough, ME 04074", "relation": "bride", "gift": "Check", "value": 300, "ty": ""},
            {"name": "Michael & Paige Munnelly", "address": "418 Concord Avenue, Exton, PA 19341", "relation": "bride", "gift": "Check", "value": 200, "ty": ""},
            {"name": "Jenna Munnelly & Max Greniger", "address": "6053 Shaffer Drive, Alexandria, VA 22310", "relation": "bride", "gift": "Check", "value": 200, "ty": ""},
            {"name": "Katie Martell", "address": "110 Charlton, 7A, New York, NY 10014", "relation": "bride", "gift": "", "value": 0, "ty": "Katie, Thank you so much for coming all the way to Florida to celebrate our wedding with us and for your generous honeymoon gift. We had the best time in Africa and kept thinking about how lucky we are to have you in our lives. Hopefully we can see you soon — I miss you already. Love, Michelle & Gray"},
            {"name": "Mary & Eric", "address": "615 Glendale Drive, Glenview, IL 60025", "relation": "bride", "gift": "Cash Fund – Honeymoon Resort", "value": 400, "ty": "Mary & Eric, Thank you so much for being part of our wedding party and for your incredibly generous honeymoon gift. Mary, your speech at the rehearsal on Friday night meant the world to me. I loved spending so much time with you throughout the weekend, and you helping me figure out my tennis shoes still makes me laugh. I had the best time celebrating with you both. Love, Michelle & Gray"},
            {"name": "Liza & Mike McNulty", "address": "2515 Beeler St, Denver, CO 80238", "relation": "bride", "gift": "Napkin Rings", "value": 79, "ty": "Liza & Mike, Thank you so much for celebrating with us and for the beautiful napkin rings. It meant so much having family with us in Florida for the weekend. We're so grateful for your love and generosity. Xoxo, Michelle & Gray"},
            {"name": "Sapna", "address": "200 East 15th Street, Apartment 2D, New York, NY 10003", "relation": "bride", "gift": "Antique Brass Gallery Frames", "value": 95, "ty": "Sapna, Thank you so much for the gorgeous frames and for being there to celebrate with us. I know you missed the shower, but I felt your love. I'm so grateful for you and loved celebrating this chapter with you. With love, Michelle & Gray"},
            {"name": "Michael & Anna Marzano", "address": "8 Egret Way, Phoenixville, PA 19460", "relation": "bride", "gift": "SMEG Matte Mocha Toaster; Potluck Baking Dish Set (3pc)", "value": 279.90, "ty": "Anna & Michael, Thank you so much for coming to the wedding and for your amazing gift. Anna, thank you for being in the wedding and for your beautiful speech on Friday night — it meant so much to me. I had so much fun celebrating with you both, as always. Love, Michelle & Gray"},
            {"name": "Natalie Hennings", "address": "1294 South Elm Street, MONACA, PA 15061", "relation": "bride", "gift": "Cash Fund – Honeymoon Resort", "value": 50, "ty": "Natalie, Thank you for your generous honeymoon resort gift — it made our Africa trip even more special. We'll definitely let you know the next time we're in Pittsburgh, and hopefully we can see you soon. Miss you already. With love, Michelle & Gray"},
            {"name": "Emily & Uel", "address": "1336 Brooks Avenue, Raleigh, NC 27607", "relation": "bride", "gift": "Brass Salt & Pepper Mill Set", "value": 175, "ty": "Emily & Uel, Thank you so much for coming to the wedding — we had the best time celebrating with you both. Your gift is absolutely perfect, and we can't wait for our couple trip this year. Love you both. Love, Michelle & Gray"},
            {"name": "Lauren Beck", "address": "870 Pacific Street, Apt 1F, New York, NY 11238", "relation": "bride", "gift": "Estelle Colored Glass Champagne Flutes (Set of 6)", "value": 205, "ty": "Lauren, We missed you so much at the wedding, but we can't wait to celebrate at dinner in a few weeks. Thank you for the stunning glasses — they're perfect, and you know I love you so much. Love, Michelle & Gray"},
            {"name": "JV & David", "address": "35 Sawmill Lane, Greenwich, CT 06830", "relation": "bride", "gift": "Camille Long Stem Wine Glasses (Set)", "value": 419.40, "ty": "JV & David, We missed you at the wedding and hope all is well. Thank you so much for your incredibly generous gift — the glasses are absolutely perfect. With love, Michelle & Gray"},
            {"name": "Connie Giovanini", "address": "4045 Werthers Ct, Fairfax, VA 22030", "relation": "bride", "gift": "Camille Long Stem Wine Glasses", "value": 139.80, "ty": "Connie, Thank you so much for coming to the wedding and for the beautiful wine glasses. Your thoughtfulness means so much to us. It was wonderful celebrating this chapter with you. With love, Michelle & Gray"},
            {"name": "Liz & Tim", "address": "17 Danville Drive, Greenlawn, NY 11740", "relation": "bride", "gift": "Party of 12 Appetizer Plates", "value": 29.95, "ty": "Liz & Tim, Thank you so much for coming to the wedding — we had the best time celebrating with you both. And thank you for the plates — they're perfect for hosting. Hopefully you'll come visit us soon so we can put them to use together. With love, Michelle & Gray"},
            {"name": "Mary Wood", "address": "1 John street, 9C, Brooklyn, NY 11201", "relation": "bride", "gift": "Napkin holders (Pottery Barn) - Shower", "value": 79, "ty": "Mary & Chloe, Thank you both for coming to the shower and for the beautiful napkin rings. Your excitement meant so much to me. I loved celebrating with you both. Xoxo, Michelle & Gray"},
            {"name": "Chloe McCann", "address": "1 John street, 9C, Brooklyn, NY 11201", "relation": "bride", "gift": "Napkin holders (Pottery Barn) - Shower", "value": 79, "ty": "Mary & Chloe, Thank you both for coming to the shower and for the beautiful napkin rings. Your excitement meant so much to me. I loved celebrating with you both. Xoxo, Michelle & Gray"},
            {"name": "Tiff & Sashi Shah", "address": "8761 Grady Drive, Breinigsville, PA 18031", "relation": "joint", "gift": "Cash; Shower gift ($100)", "value": 100, "ty": ""},
            {"name": "Emily & Uel Whitsett", "address": "1336 Brooks Avenue, Raleigh, NC 27607", "relation": "joint", "gift": "Cash", "value": 0, "ty": ""},
            {"name": "Emily Africk", "address": "56 Seventh Ave, 3B, New York, NY 10011", "relation": "joint", "gift": "Estelle Colored Glass Stemmed Wine Glass (Set of 6); Throw; Wine glasses; Balloons (engagement)", "value": 185, "ty": "Emily, Thank you so much for coming to the wedding and for the gorgeous glasses. And thank you again for the engagement balloons — you're always so thoughtful. I loved celebrating this chapter with you. Love you endlessly. With love, Michelle & Gray"},
            {"name": "Steve & Kathy Saunders", "address": "4657 Saint Benet Ct., Fort Worth, TX 76126", "relation": "joint", "gift": "Caraway 5-Piece Utensil Set; Check", "value": 545, "ty": ""},
            {"name": "Zara Lopez", "address": "6401 Rialto Blvd., 238, Austin, TX 78735", "relation": "joint", "gift": "Marble Wine Cooler; Capri Blue Volcano Candle", "value": 77.95, "ty": ""},
            {"name": "Dan & Jenny Hubner", "address": "89 Voorhis Ave, Rockville Centre, NY 11570", "relation": "bride", "gift": "Tall Ramekins (Set of 4); Monique Lhuillier Arles Footed Bowl", "value": 92.80, "ty": "Jenny, Thank you so much for coming to the shower and for the beautiful gifts. Your excitement about celebrating me as a bride made everything even more special. I love you so much. Love, Michelle & Gray"},
            {"name": "Christopher Humes", "address": "1 Missouri Avenue, Rensselaer, NY 12144", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Frazer Humes", "address": "1400 Ivy Street, Denver, CO 80220", "relation": "joint", "gift": "Bowl from canada", "value": 0, "ty": ""},
            {"name": "Jeff & Terri Humes", "address": "207 Gainswood Drive, Mooresville, NC 28117", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Jennifer Humes", "address": "1 MISSOURI AVE, RENSSELAER, NY 12144", "relation": "joint", "gift": "Reversible Ceramic Double Griddle", "value": 149.95, "ty": ""},
            {"name": "Gray Perkins", "address": "125 West 21st Street, Apartment 11C, New York, NY 10011", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "T.J. & Meg Humes", "address": "2807 North Nottingham Street, Arlington, VA 22207", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "William & Elsie Humes", "address": "18 Brookside Drive, Greenwood Village, CO 80121", "relation": "joint", "gift": "Caraway Baking Sheet; Holiday Skiers Platter", "value": 119.50, "ty": ""},
            {"name": "Jessica Humes-Delgado", "address": "12 Cedar Lane, Rhinebeck, NY 12572", "relation": "bride", "gift": "Measuring Cups (Set of 4); Skier Jack Hand Towel; Heritage Pie Dish", "value": 140, "ty": "Jessica, Thank you for coming to the wedding and for being my bridesmaid. Having you by my side meant everything to me, and your speech on Friday night was so heartfelt. And of course — thank you for fixing the flower girl basket, even if Ruby rudely didn't end up using it. You've always been right there for me when I need you, and I had the best time celebrating with you all weekend. Love you, Michelle & Gray"},
            {"name": "Noel Delgado", "address": "12 Cedar Lane, Rhinebeck, NY 12572", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Sapna Jalan", "address": "200 East 15th Street, Apartment 2D, New York, NY 10003", "relation": "joint", "gift": "Antique Brass Gallery Frames", "value": 95, "ty": ""},
            {"name": "Beverly & Ian Johnson", "address": "18 Sawmill Lane, Greenwich, CT 06830", "relation": "joint", "gift": "Kaloh Dinnerware Set (16pc); Kaloh Mixing Bowls (Set of 3)", "value": 287.60, "ty": ""},
            {"name": "Sasha Johnson", "address": "61 East 77, 4b, New York, NY 10075", "relation": "joint", "gift": "Scalloped Edge Placemat (Set of 4); Bamboo Natural Large Pitcher", "value": 272, "ty": ""},
            {"name": "Charlie & Libby King", "address": "11 Oakwood Lane, Greenwich, CT 06830", "relation": "joint", "gift": "Estelle Colored Glass Set of 6 Stem Coupes; Speckled Fruit Stand", "value": 455, "ty": ""},
            {"name": "Carolina Lira", "address": "Av. Ricardo Lyon 2801, Apartment 74, Chile", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Fernanda Carvajal", "address": "Av. Ricardo Lyon 2801, Apartment 74, Chile", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Jake & Krysty Long", "address": "543 Dean Road, Mars, PA 16046", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Jack & Amy Lowden", "address": "8 Deer Park Ct, Greenwich, CT 06830", "relation": "joint", "gift": "Berry & Thread Hostess Set (5pc); Ivory 20-Piece Flatware Set", "value": 708.75, "ty": ""},
            {"name": "Jenna & Bryan MacPhie", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Baxter & Sam Male", "address": "731 Kroger Valley Drive, Cincinnati, OH 45226", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Katie Martell", "address": "1185 Park Ave, New York, NY 10128", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 150, "ty": ""},
            {"name": "Gary & Lisa Matson", "address": "8 Crosswood Way, Manchester, NH 03102", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Amy & Dan McCauley", "address": "1006 Weatherburn Dr., Valencia, PA 16059", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort; Kaloh Melamine Outdoor Serveware; Kaloh Melamine Tray", "value": 321.20, "ty": ""},
            {"name": "Stephen & Margaret McLain", "address": "110 South Dorothy Lane, Troy, OH 45373", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "William McLain", "address": "139 Hickory Lane, Wyomissing, PA 19610", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Gary & Jacqueline Meek", "address": "106 Easton Dr, Mooresville, NC 28117", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 100, "ty": ""},
            {"name": "Tom & Brooks Melly", "address": "25 Meadowcroft Lane, Greenwich, CT 06830", "relation": "joint", "gift": "Make Mine A Double Cocktail Napkins; Speckled Serving Plate", "value": 288, "ty": ""},
            {"name": "Sabrina Messmer", "address": "155 East 26th Street, New York, NY 10010", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 100, "ty": ""},
            {"name": "Zelda & Matt Moss", "address": "125 Peck Lane, Suffolk, VA 23434", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Edouard & Kelley Moueix", "address": "Chateau Belair Monange, France", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 300, "ty": ""},
            {"name": "Katie & Frank Mueller", "address": "219 Barbara Ann Drive, Reedsburg, WI 53959", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 200, "ty": ""},
            {"name": "Anne Munnelly", "address": "9000 236th Court, 33A, Salem, WI 54168", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 300, "ty": ""},
            {"name": "Connor Munnelly & Lauren Aldrich", "address": "117 E Chestnut Street, #412, West Chester, PA 19380", "relation": "joint", "gift": "Cash", "value": 0, "ty": ""},
            {"name": "Martie & Jenna Munnelly", "address": "10116 South Spartan Lane, Oak Creek, WI 53154", "relation": "joint", "gift": "Check", "value": 200, "ty": ""},
            {"name": "Rachel Munnelly", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Mr. Joseph & Mrs. Susan Nicholas", "address": "199 Timber Lake Drive, Troutman, NC 28166", "relation": "joint", "gift": "Check", "value": 500, "ty": ""},
            {"name": "Danielle Olivera & Eoin Heavey", "address": "440 Kent Avenue, 8E, Brooklyn, NY 11249", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Gordy & Linda Opitz", "address": "540 Salem Heights Dr, Gibsonia, PA 15044", "relation": "joint", "gift": "Caraway 4-Piece Cutting Board Set; Check; Shower gift ($245)", "value": 990, "ty": ""},
            {"name": "Lizzy Oullette", "address": "2 East Elm Street, Apartment 27, Greenwich, CT 06830", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Bridgette & Joel Pepmeyer", "address": "316 3RD ST, Aspinwall, PA 15215", "relation": "bride", "gift": "Arles Gravy Boat; Kanto Serving Platter; Caraway Nonstick Sauce Pan", "value": 203.50, "ty": "Bridgette & Joel, Thank you so much for coming to the wedding and for your beautiful gifts. We loved celebrating with you both — it meant so much to have you there. Love, Michelle & Gray"},
            {"name": "Isabelle & Harry Perkins", "address": "872 Madison Avenue, 5B, New York, NY 10021", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Bryan Portillo", "address": "210 East 26th Street, Apartment 1G, New York, NY 10010", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Elsie & Brian Pringle", "address": "7424 Marilyn Avenue NE, Albuquerque, NM 87109", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Peter & Alexa Quinn", "address": "6341 Ridgeway Road, Richmond, VA 23226", "relation": "joint", "gift": "York Mirror 5-Piece Flatware Set", "value": 159.80, "ty": ""},
            {"name": "Terry & Allen Ravas", "address": "129 Ballston Drive, Mooresville, NC 28117", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Graham & Caroline Reynolds", "address": "2-21 Malt Drive, Apt 238, Long Island City, NY 11101", "relation": "joint", "gift": "Business & Pleasure Beach Blanket", "value": 119, "ty": ""},
            {"name": "Kris Rodgers & Joanna Chinichi", "address": "130 Barrow Street, Apartment 509, New York, NY 10014", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Vlora Rraci", "address": "10 Jones Street, 2A, New York, NY 10014", "relation": "joint", "gift": "Aspen 8oz Martini Glass", "value": 49.95, "ty": ""},
            {"name": "Brendan Salvadore", "address": "245 Mulberry Street, Apartment 20, New York, NY 10012", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 250, "ty": ""},
            {"name": "Kelly Salvadore", "address": "130 West Beardsley Avenue, Brant Beach, NJ 08008", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 300, "ty": ""},
            {"name": "Mr. Kelly & Mrs. Tammy Salvadore", "address": "130 West Beardsley Avenue, Brant Beach, NJ 08008", "relation": "joint", "gift": "Check", "value": 1000, "ty": ""},
            {"name": "Margaret Salvadore", "address": "130 W Beardsley Ave, Beach Haven, NJ 08008", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 300, "ty": ""},
            {"name": "Anthony D'Andreti & Scott Salvator", "address": "1600 Spruce Street, Floor 4, Philadelphia, PA 19103", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Michael Zabriskie & Jessica San Filippo", "address": "308 East 79th Street, 1L, New York, NY 10075", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Scott San Filippo & Steve Saunders", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Ryan Setian & Gaby Cortes", "address": "71 Kensington Gardens Square, Flat 7, Great Britain", "relation": "joint", "gift": "Venmo", "value": 400, "ty": ""},
            {"name": "Tiffany Shah", "address": "8761 Grady Drive, Breinigsville, PA 18031", "relation": "joint", "gift": "Kanto Stoneware Condiment Bowl Sets", "value": 104, "ty": ""},
            {"name": "Shashi Shah & Elliott Simon", "address": "105 5th Avenue, 6C, New York, NY 10003", "relation": "joint", "gift": "Acacia Cheese Board Set; Condiment Trio", "value": 444.95, "ty": ""},
            {"name": "Samantha & Jonathan Simon", "address": "320 Old Church Road, Greenwich, CT 06830", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Joann Sirera", "address": "4801 Wexford Run Road, Wexford, PA 15090", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort (500 + 200)", "value": 700, "ty": ""},
            {"name": "Melissa & Sam Thacker", "address": "13021 Malletto Drive, Austin, TX 78739", "relation": "joint", "gift": "Verre Fluted Vase (Set of 5)", "value": 165, "ty": ""},
            {"name": "Alex Tirey", "address": "2009 Holland Avenue, Unit A, Austin, TX 78704", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Doug & Lisa Trepp", "address": "408 Riversville Road, Greenwich, CT 06831", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Nick Trepp", "address": "440 Washington Street, 703, New York, NY 10013", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 150, "ty": ""},
            {"name": "Will Trepp & Sydney Canfield", "address": "2 Cornelia Street, 601, New York, NY 10014", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Jane Van Dam", "address": "9 Sextant Lane, Scarborough, ME 04074", "relation": "joint", "gift": "Check", "value": 300, "ty": ""},
            {"name": "Bea Van Dam", "address": "88 4th Street #2, Bangor, ME 04401", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Walker Ward & Anna Catherine Wilson", "address": "233 Carter Road, Princeton, NJ 08540", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Emily & Uel Whitsett", "address": "1336 Brooks Avenue, Raleigh, NC 27607", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Fareesa Abbasi", "address": "332 Bedford Avenue, Apartment 1F, Brooklyn, NY 11249", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Andy & Susan Alisberg", "address": "12 Dewart Road, Greenwich, CT 06830", "relation": "joint", "gift": "Jeanne Fitz Salad Bowl & Servers; Monos Check-In Large; All-Clad Stainless-Steel Utensils", "value": 804.94, "ty": ""},
            {"name": "Matt & Katie Arundel", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Kaitlin & Michael Booth", "address": "521 East Union Street, West Chester, PA 19382", "relation": "joint", "gift": "Check", "value": 400, "ty": ""},
            {"name": "Kerry & Pamela Bove", "address": "133 Birch Drive, Wexford, PA 15090", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Peter & Lori Clauson", "address": "307 Bayley Road, Charleston, SC 29492", "relation": "joint", "gift": "Amelia Scalloped Bath Towel Bundle", "value": 300, "ty": ""},
            {"name": "Jason Cleary & Lauren Connors", "address": "5419 Western Avenue, Omaha, NE 68132", "relation": "joint", "gift": "Beast Blender Mega 1200", "value": 184, "ty": ""},
            {"name": "Kempton & Cat Coady", "address": "136 Waverly Place, Apartment 12c, New York, NY 10014", "relation": "joint", "gift": "Check", "value": 300, "ty": ""},
            {"name": "Tom & Francie Corcoran", "address": "903 Sutton Hill Road, Nashville, TN 37204", "relation": "joint", "gift": "Le Creuset Covered Rectangular Casserole", "value": 134.99, "ty": ""},
            {"name": "Alec & Kelsey Demet", "address": "8562 East Pierce Street, Scottsdale, AZ 85257", "relation": "groom", "gift": "Cash Fund – Honeymoon Resort", "value": 300, "ty": ""},
            {"name": "Quinn & Kathleen Drinan", "address": "233 Pacific Street, #4C, Brooklyn, NY 11201", "relation": "joint", "gift": "Seashell bowls", "value": 0, "ty": ""},
            {"name": "David & Jennifer Evans", "address": "35 Sawmill Lane, Greenwich, CT 06830", "relation": "joint", "gift": "Camille Long Stem Wine Glasses (Set)", "value": 419.40, "ty": ""},
            {"name": "Eric & Mary Flanagan", "address": "615 Glendale Drive, Glenview, IL 60025", "relation": "joint", "gift": "Zola gift", "value": 400, "ty": ""},
            {"name": "Doug & Kristin Flynn", "address": "1 North 4th Place, Apartment 3D, Brooklyn, NY 11249", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Don & Eileen Foster", "address": "404 Applehill Court, Gibsonia, PA 15044", "relation": "joint", "gift": "Le Creuset Classic Heritage Covered Casserole Dish; Check", "value": 269.98, "ty": ""},
            {"name": "Patrick Gradus & Salen Andrews", "address": "901 H Street NE, Apartment 420, Washington, DC 20002", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Salen Andrews", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Sam Harris", "address": "515 east 88th st, Apt 3G, New York, NY 10128", "relation": "joint", "gift": "Antibes Wicker Handled Serve Tray", "value": 129, "ty": ""},
            {"name": "Natalie Hennings & Brandyn Defelice", "address": "1294 South Elm Street, MONACA, PA 15061", "relation": "joint", "gift": "Cash Fund – Honeymoon Resort", "value": 50, "ty": ""},
            {"name": "Brandyn Defelice", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Paul & Lisa Hogan", "address": "128 Attleboro Place, Mooresville, NC 28117", "relation": "joint", "gift": "Check", "value": 800, "ty": ""},
            {"name": "Liz Hopkins", "address": "17 Danville Drive, Greenlawn, NY 11740", "relation": "joint", "gift": "Party of 12 Appetizer Plates", "value": 29.95, "ty": ""},
            {"name": "Tim Heller", "address": "70 West 93rd Street, Apartment 24E, New York, NY 10025", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Jessica Houghton", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Joseph Darco", "address": "", "relation": "joint", "gift": "", "value": 0, "ty": ""},
            {"name": "Edward Howard & Robin Perkins", "address": "103 West Lyon Farm Dr., Greenwich, CT 06831", "relation": "joint", "gift": "Caraway Squareware Set; Caraway Roasting Pan", "value": 760, "ty": ""},
            {"name": "Henry Bassett", "address": "1208 E Rock Springs Rd Ne, Atlanta, GA 30306", "relation": "joint", "gift": "High-Glass Pedestal Candleholders; Avanti G2 Touchscreen Nugget Ice Dispenser", "value": 478.65, "ty": ""}
        ];

        let progress = JSON.parse(localStorage.getItem('tyProgress') || '{}');
        let edits = JSON.parse(localStorage.getItem('tyEdits') || '{}');
        let deletions = JSON.parse(localStorage.getItem('tyDeletions') || '[]');
        let sortColumn = 'name';
        let sortDirection = 'asc';

        // =============================================
        // SUPABASE SYNC FUNCTIONS
        // =============================================

        async function loadFromSupabase() {
            if (!syncEnabled) return false;

            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');

                const { data, error } = await supabase
                    .from('wedding_tracker')
                    .select('*')
                    .eq('id', 'shared_data')
                    .single();

                document.getElementById('loadingOverlay').classList.add('hidden');

                if (error && error.code !== 'PGRST116') {
                    console.error('Supabase load error:', error);
                    return false;
                }

                if (data) {
                    console.log('=== SUPABASE DATA LOADED ===');
                    console.log('Raw data.edits:', data.edits);
                    console.log('data.edits type:', typeof data.edits);
                    console.log('Edits keys:', data.edits ? Object.keys(data.edits) : 'null/undefined');

                    // Check specifically for Alec & Kelsey
                    if (data.edits) {
                        const alecKey = Object.keys(data.edits).find(k => k.includes('Alec'));
                        if (alecKey) {
                            console.log('Found Alec entry:', JSON.stringify(alecKey), '=', JSON.stringify(data.edits[alecKey]));
                        }
                    }

                    progress = data.progress || {};
                    deletions = data.deletions || [];

                    // Normalize edits keys - fix any potential HTML entity encoding issues
                    const rawEdits = data.edits || {};
                    edits = {};
                    Object.keys(rawEdits).forEach(key => {
                        // Normalize the key: decode HTML entities and normalize unicode
                        const normalizedKey = key
                            .replace(/&amp;/g, '&')
                            .replace(/&#39;/g, "'")
                            .replace(/&quot;/g, '"')
                            .replace(/&#x27;/g, "'");
                        edits[normalizedKey] = rawEdits[key];
                        if (normalizedKey !== key) {
                            console.log('Normalized key:', JSON.stringify(key), '->', JSON.stringify(normalizedKey));
                        }
                    });

                    console.log('After normalization - edits keys:', Object.keys(edits));
                    console.log('=== END SUPABASE DATA ===');

                    // Also save to localStorage as cache
                    localStorage.setItem('tyProgress', JSON.stringify(progress));
                    localStorage.setItem('tyEdits', JSON.stringify(edits));
                    localStorage.setItem('tyDeletions', JSON.stringify(deletions));
                }

                return true;
            } catch (err) {
                console.error('Supabase load error:', err);
                document.getElementById('loadingOverlay').classList.add('hidden');
                return false;
            }
        }

        async function saveToSupabase() {
            if (!syncEnabled) {
                console.log('Sync not enabled');
                return;
            }

            try {
                showSyncIndicator('syncing');

                const { error } = await supabase
                    .from('wedding_tracker')
                    .upsert({
                        id: 'shared_data',
                        progress: progress,
                        edits: edits,
                        deletions: deletions,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'id' });

                if (error) {
                    console.error('Supabase save error:', error);
                    alert('Save failed: ' + error.message + '\n\nTry disabling Row Level Security in Supabase SQL Editor:\nALTER TABLE wedding_tracker DISABLE ROW LEVEL SECURITY;');
                    showSyncIndicator('error');
                    return;
                }

                showSyncIndicator('success');
            } catch (err) {
                console.error('Supabase save error:', err);
                alert('Save failed: ' + err.message);
                showSyncIndicator('error');
            }
        }

        function showSyncIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.remove('saving', 'syncing', 'error');

            if (status === 'syncing') {
                indicator.textContent = 'Syncing...';
                indicator.classList.add('syncing');
            } else if (status === 'error') {
                indicator.textContent = 'Sync error - saved locally';
                indicator.classList.add('error');
                setTimeout(() => {
                    indicator.textContent = 'All changes saved locally';
                    indicator.classList.remove('error');
                }, 3000);
            } else if (status === 'success') {
                indicator.textContent = syncEnabled ? 'All changes synced' : 'All changes saved locally';
                setTimeout(() => {
                    indicator.textContent = syncEnabled ? 'All changes synced' : 'All changes saved locally';
                }, 500);
            }
        }

        // Debounced save to avoid too many API calls
        let saveTimeout = null;
        function debouncedSaveToSupabase() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToSupabase, 1000);
        }

        // Helper function to normalize names for matching
        function normalizeName(name) {
            return name
                .replace(/&amp;/g, '&')
                .replace(/&#39;/g, "'")
                .replace(/&quot;/g, '"')
                .replace(/&#x27;/g, "'")
                .replace(/\\'/g, "'")
                .trim();
        }

        // Build a lookup map with normalized keys for faster matching
        function buildEditsLookup() {
            const lookup = {};
            Object.keys(edits).forEach(key => {
                const normalizedKey = normalizeName(key);
                lookup[normalizedKey] = edits[key];
                // Also keep original key mapping
                lookup[key] = edits[key];
            });
            return lookup;
        }

        // Apply saved edits and deletions to data
        function applyEdits() {
            console.log('=== APPLY EDITS START ===');
            console.log('edits keys:', Object.keys(edits));
            console.log('Total edits:', Object.keys(edits).length);

            // Build normalized lookup
            const editsLookup = buildEditsLookup();
            console.log('Lookup keys:', Object.keys(editsLookup));

            // Debug: Check for Alec specifically
            const alecInGiftData = giftData.find(g => g.name.includes('Alec'));
            const alecInEdits = Object.keys(edits).find(k => k.includes('Alec'));
            console.log('Alec in giftData:', alecInGiftData ? JSON.stringify(alecInGiftData.name) : 'NOT FOUND');
            console.log('Alec in edits:', alecInEdits ? JSON.stringify(alecInEdits) : 'NOT FOUND');
            if (alecInGiftData && alecInEdits) {
                console.log('Alec names match:', alecInGiftData.name === alecInEdits);
                console.log('giftData name chars:', [...alecInGiftData.name].map(c => c.charCodeAt(0)));
                console.log('edits key chars:', [...alecInEdits].map(c => c.charCodeAt(0)));
            }

            // Apply deletions first
            giftData = giftData.filter(g => !deletions.includes(g.name));

            // Apply edits to existing guests
            let matchCount = 0;
            let relationUpdates = 0;
            giftData.forEach((g, i) => {
                // Normalize the guest name for lookup
                const normalizedGuestName = normalizeName(g.name);

                // Try multiple lookup strategies
                let editEntry = editsLookup[g.name] ||
                               editsLookup[normalizedGuestName] ||
                               edits[g.name] ||
                               edits[normalizedGuestName];

                // If still no match, try to find a fuzzy match
                if (!editEntry) {
                    const similarKey = Object.keys(edits).find(k => {
                        const normalizedK = normalizeName(k);
                        return normalizedK === normalizedGuestName ||
                               k.toLowerCase() === g.name.toLowerCase() ||
                               normalizedK.toLowerCase() === normalizedGuestName.toLowerCase();
                    });
                    if (similarKey) {
                        console.log('FUZZY MATCH! giftData:', JSON.stringify(g.name), 'edits key:', JSON.stringify(similarKey));
                        editEntry = edits[similarKey];
                    }
                }

                if (editEntry) {
                    matchCount++;
                    console.log('Match found for:', g.name, 'Edit:', JSON.stringify(editEntry));
                    if (editEntry.newName) giftData[i].name = editEntry.newName;
                    if (editEntry.gift !== undefined) giftData[i].gift = editEntry.gift;
                    if (editEntry.relation !== undefined) {
                        relationUpdates++;
                        console.log('APPLYING RELATION:', editEntry.relation, 'to', g.name, '(was:', g.relation, ')');
                        giftData[i].relation = editEntry.relation;
                    }
                    if (editEntry.address !== undefined) giftData[i].address = editEntry.address;
                    if (editEntry.value !== undefined) giftData[i].value = editEntry.value;
                    if (editEntry.ty !== undefined) giftData[i].ty = editEntry.ty;
                }
            });
            console.log('Total matches:', matchCount, 'Relation updates:', relationUpdates);
            console.log('=== APPLY EDITS END ===');

            // Add new guests that were created
            Object.keys(edits).forEach(name => {
                if (edits[name].isNew && !giftData.some(g => g.name === name)) {
                    giftData.unshift({
                        name: name,
                        address: edits[name].address || '',
                        relation: edits[name].relation || 'joint',
                        gift: edits[name].gift || '',
                        value: edits[name].value || 0,
                        ty: edits[name].ty || ''
                    });
                }
            });
        }

        function getProgress(name, field) {
            return progress[name] && progress[name][field] || false;
        }

        function setProgress(name, field, value) {
            name = name.replace(/&amp;/g, '&').replace(/\\'/g, "'");
            if (!progress[name]) progress[name] = {};
            progress[name][field] = value;
            localStorage.setItem('tyProgress', JSON.stringify(progress));
            showSaveIndicator();
            debouncedSaveToSupabase();
            updateStats();
            renderTable();
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = 'Saving...';
            indicator.classList.add('saving');
            setTimeout(() => {
                indicator.textContent = syncEnabled ? 'All changes synced' : 'All changes saved locally';
                indicator.classList.remove('saving');
            }, 500);
        }

        async function manualSave() {
            // Debug: Log what we're about to save
            console.log('manualSave - edits object being saved:', JSON.stringify(edits, null, 2));

            // Save to localStorage
            localStorage.setItem('tyProgress', JSON.stringify(progress));
            localStorage.setItem('tyEdits', JSON.stringify(edits));
            localStorage.setItem('tyDeletions', JSON.stringify(deletions));

            // Sync to Supabase immediately
            if (syncEnabled) {
                const indicator = document.getElementById('saveIndicator');
                indicator.textContent = 'Saving to cloud...';
                indicator.classList.add('syncing');

                try {
                    const { error } = await supabase
                        .from('wedding_tracker')
                        .upsert({
                            id: 'shared_data',
                            progress: progress,
                            edits: edits,
                            deletions: deletions,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'id' });

                    if (error) {
                        alert('Save FAILED: ' + error.message + '\n\nRun this in Supabase SQL Editor:\nALTER TABLE wedding_tracker DISABLE ROW LEVEL SECURITY;');
                        indicator.textContent = 'Save failed!';
                        indicator.classList.remove('syncing');
                        indicator.classList.add('error');
                        return;
                    }

                    alert('Saved successfully!');
                    indicator.textContent = 'All changes synced!';
                    indicator.classList.remove('syncing');
                } catch (err) {
                    alert('Save FAILED: ' + err.message);
                    indicator.textContent = 'Save failed!';
                    indicator.classList.remove('syncing');
                    indicator.classList.add('error');
                }
            } else {
                alert('Saved to local storage (Supabase not configured)');
                showSaveIndicator();
            }
        }

        function saveEdit(originalName, field, newValue) {
            originalName = originalName.replace(/&amp;/g, '&').replace(/\\'/g, "'");
            console.log('saveEdit called:', originalName, field, newValue);
            if (!edits[originalName]) edits[originalName] = {};
            edits[originalName][field] = newValue;
            localStorage.setItem('tyEdits', JSON.stringify(edits));
            showSaveIndicator();
            debouncedSaveToSupabase();

            // Update giftData - find by original name or by renamed name
            let idx = giftData.findIndex(g => g.name === originalName);
            if (idx === -1 && edits[originalName] && edits[originalName].newName) {
                // Guest was renamed, find by new name
                idx = giftData.findIndex(g => g.name === edits[originalName].newName);
            }
            if (idx !== -1) {
                if (field === 'newName') giftData[idx].name = newValue;
                if (field === 'gift') giftData[idx].gift = newValue;
                if (field === 'relation') giftData[idx].relation = newValue;
                if (field === 'address') giftData[idx].address = newValue;
                if (field === 'value') giftData[idx].value = newValue;
                if (field === 'ty') giftData[idx].ty = newValue;
            }
            updateStats();
            renderTable();
        }

        function updateStats() {
            // Get current filter values
            const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || 'all';
            const relationFilter = document.getElementById('filterRelation')?.value || 'all';

            // Apply the same filtering logic as renderTable
            const filtered = giftData.filter(g => {
                const searchMatch = g.name.toLowerCase().includes(search) ||
                                   g.address.toLowerCase().includes(search) ||
                                   g.gift.toLowerCase().includes(search);

                let statusMatch = true;
                if (statusFilter === 'needs-envelope') statusMatch = !getProgress(g.name, 'envelope');
                if (statusFilter === 'needs-writing') statusMatch = !getProgress(g.name, 'written');
                if (statusFilter === 'needs-sending') statusMatch = !getProgress(g.name, 'sent');
                if (statusFilter === 'completed') statusMatch = getProgress(g.name, 'sent');
                if (statusFilter === 'has-gift') statusMatch = g.gift && g.gift.length > 0;
                if (statusFilter === 'no-gift') statusMatch = !g.gift || g.gift.length === 0;

                let relationMatch = relationFilter === 'all' || g.relation === relationFilter;

                return searchMatch && statusMatch && relationMatch;
            });

            const total = filtered.length;
            let envelopes = 0, written = 0, sent = 0, giftsReceived = 0;

            filtered.forEach(g => {
                if (getProgress(g.name, 'envelope')) envelopes++;
                if (getProgress(g.name, 'written')) written++;
                if (getProgress(g.name, 'sent')) sent++;
                if (g.gift && g.gift.length > 0 && g.gift !== 'No gift recorded') giftsReceived++;
            });

            const notesRemaining = giftsReceived - sent;

            // Update stat card labels based on filter
            const filterLabel = relationFilter !== 'all' ? ` (${relationFilter.charAt(0).toUpperCase() + relationFilter.slice(1)})` : '';

            document.getElementById('totalGuests').textContent = total;
            document.getElementById('giftsReceived').textContent = giftsReceived;
            document.getElementById('notesRemaining').textContent = notesRemaining;
            document.getElementById('envelopesCreated').textContent = envelopes;
            document.getElementById('notesWritten').textContent = written;
            document.getElementById('notesSent').textContent = sent;

            // Update progress bars based on filtered data
            const progressBase = giftsReceived > 0 ? giftsReceived : total;
            document.getElementById('envelopeProgress').style.width = (total > 0 ? envelopes/total*100 : 0) + '%';
            document.getElementById('writtenProgress').style.width = (progressBase > 0 ? written/progressBase*100 : 0) + '%';
            document.getElementById('sentProgress').style.width = (progressBase > 0 ? sent/progressBase*100 : 0) + '%';

            // Update labels to show filter context
            updateStatLabels(relationFilter, statusFilter);
        }

        function updateStatLabels(relationFilter, statusFilter) {
            const suffix = relationFilter !== 'all' ? ` (${relationFilter.charAt(0).toUpperCase() + relationFilter.slice(1)})` : '';

            // Update the h3 labels in stat cards
            const labels = {
                'totalGuests': `Total Guests${suffix}`,
                'giftsReceived': `Gifts Received${suffix}`,
                'notesRemaining': `TY Notes Remaining${suffix}`,
                'envelopesCreated': `Envelopes Created${suffix}`,
                'notesWritten': `Notes Written${suffix}`,
                'notesSent': `Notes Sent${suffix}`
            };

            Object.entries(labels).forEach(([id, label]) => {
                const el = document.getElementById(id);
                if (el && el.previousElementSibling && el.previousElementSibling.tagName === 'H3') {
                    el.previousElementSibling.textContent = label;
                }
            });
        }

        function renderTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const relationFilter = document.getElementById('filterRelation').value;

            let filtered = giftData.filter(g => {
                const searchMatch = g.name.toLowerCase().includes(search) ||
                                   g.address.toLowerCase().includes(search) ||
                                   g.gift.toLowerCase().includes(search);

                let statusMatch = true;
                if (statusFilter === 'needs-envelope') statusMatch = !getProgress(g.name, 'envelope');
                if (statusFilter === 'needs-writing') statusMatch = !getProgress(g.name, 'written');
                if (statusFilter === 'needs-sending') statusMatch = !getProgress(g.name, 'sent');
                if (statusFilter === 'completed') statusMatch = getProgress(g.name, 'sent');
                if (statusFilter === 'has-gift') statusMatch = g.gift && g.gift.length > 0;
                if (statusFilter === 'no-gift') statusMatch = !g.gift || g.gift.length === 0;

                let relationMatch = relationFilter === 'all' || g.relation === relationFilter;

                return searchMatch && statusMatch && relationMatch;
            });

            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch(sortColumn) {
                    case 'value': aVal = a.value; bVal = b.value; break;
                    case 'envelope': aVal = getProgress(a.name, 'envelope') ? 1 : 0; bVal = getProgress(b.name, 'envelope') ? 1 : 0; break;
                    case 'written': aVal = getProgress(a.name, 'written') ? 1 : 0; bVal = getProgress(b.name, 'written') ? 1 : 0; break;
                    case 'sent': aVal = getProgress(a.name, 'sent') ? 1 : 0; bVal = getProgress(b.name, 'sent') ? 1 : 0; break;
                    case 'xmasCard': aVal = getProgress(a.name, 'xmasCard') ? 1 : 0; bVal = getProgress(b.name, 'xmasCard') ? 1 : 0; break;
                    default: aVal = a[sortColumn] || ''; bVal = b[sortColumn] || '';
                }
                if (typeof aVal === 'string') {
                    return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filtered.map(g => {
                const isCompleted = getProgress(g.name, 'sent');
                const hasGift = g.gift && g.gift.length > 0;
                const originalName = Object.keys(edits).find(k => edits[k].newName === g.name) || g.name;
                const relationClass = `relation-${g.relation}`;
                const escapedName = g.name.replace(/&/g, '&amp;').replace(/'/g, "\\'");
                const escapedOriginal = originalName.replace(/&/g, '&amp;').replace(/'/g, "\\'");
                const htmlEscapedOriginal = originalName.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return `
                    <tr class="${isCompleted ? 'completed' : ''}">
                        <td><span class="editable guest-name" contenteditable="true" data-original="${htmlEscapedOriginal}" data-field="newName" onblur="handleEdit(this)">${g.name}</span></td>
                        <td><span class="editable address ${!g.address ? 'empty' : ''}" contenteditable="true" data-original="${htmlEscapedOriginal}" data-field="address" data-placeholder="No address" onblur="handleEdit(this)">${g.address || ''}</span></td>
                        <td>
                            <select class="relation-select ${relationClass}" onchange="saveEdit('${escapedOriginal}', 'relation', this.value); this.className='relation-select relation-'+this.value;">
                                <option value="joint" ${g.relation === 'joint' ? 'selected' : ''}>Joint</option>
                                <option value="bride" ${g.relation === 'bride' ? 'selected' : ''}>Bride</option>
                                <option value="groom" ${g.relation === 'groom' ? 'selected' : ''}>Groom</option>
                            </select>
                        </td>
                        <td><span class="editable gift ${!hasGift ? 'empty' : ''}" contenteditable="true" data-original="${htmlEscapedOriginal}" data-field="gift" data-placeholder="No gift" onblur="handleEdit(this)">${hasGift ? g.gift : ''}</span></td>
                        <td><span class="editable value ${!g.value ? 'empty' : ''}" contenteditable="true" data-original="${htmlEscapedOriginal}" data-field="value" data-placeholder="-" onblur="handleEdit(this)">${g.value ? '$' + g.value.toFixed(2) : ''}</span></td>
                        <td class="ty-preview" onclick="showTyNote('${escapedName}', '${(g.ty || '').replace(/'/g, "\\'").replace(/\n/g, "\\n")}')">${g.ty ? g.ty.substring(0, 40) + '...' : '<span class="no-gift">No draft</span>'}</td>
                        <td class="checkbox-cell">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" ${getProgress(g.name, 'envelope') ? 'checked' : ''} onchange="setProgress('${escapedName}', 'envelope', this.checked)">
                            </div>
                        </td>
                        <td class="checkbox-cell">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" ${getProgress(g.name, 'written') ? 'checked' : ''} onchange="setProgress('${escapedName}', 'written', this.checked)">
                            </div>
                        </td>
                        <td class="checkbox-cell">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" ${getProgress(g.name, 'sent') ? 'checked' : ''} onchange="setProgress('${escapedName}', 'sent', this.checked)">
                            </div>
                        </td>
                        <td class="checkbox-cell">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" ${getProgress(g.name, 'xmasCard') ? 'checked' : ''} onchange="setProgress('${escapedName}', 'xmasCard', this.checked)">
                            </div>
                        </td>
                        <td class="checkbox-cell">
                            <button class="delete-btn" onclick="deleteRow('${escapedName}')">X</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function handleEdit(el) {
            const originalName = el.dataset.original.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&');
            const field = el.dataset.field;
            let newValue = el.innerText.trim();

            // Clean up placeholders
            if (newValue === 'No gift' || newValue === 'No address' || newValue === '-' || newValue === '') {
                newValue = '';
                el.classList.add('empty');
            } else {
                el.classList.remove('empty');
            }

            // Handle value field - parse number
            if (field === 'value') {
                newValue = parseFloat(newValue.replace(/[$,]/g, '')) || 0;
                if (newValue === 0) {
                    el.classList.add('empty');
                    el.textContent = '';
                }
            }

            saveEdit(originalName, field, newValue);
        }

        function deleteRow(name) {
            if (confirm(`Delete "${name}" from the list?`)) {
                const idx = giftData.findIndex(g => g.name === name);
                if (idx !== -1) {
                    giftData.splice(idx, 1);
                    // Track deletions
                    deletions.push(name);
                    localStorage.setItem('tyDeletions', JSON.stringify(deletions));
                    showSaveIndicator();
                    debouncedSaveToSupabase();
                    updateStats();
                    renderTable();
                }
            }
        }

        function addNewGuest() {
            const name = prompt('Enter guest name:');
            if (!name || name.trim() === '') return;

            // Check if name already exists
            if (giftData.some(g => g.name.toLowerCase() === name.trim().toLowerCase())) {
                alert('A guest with this name already exists!');
                return;
            }

            const newGuest = {
                name: name.trim(),
                address: '',
                relation: 'joint',
                gift: '',
                value: 0,
                ty: ''
            };

            giftData.unshift(newGuest); // Add to beginning of list

            // Save as an edit so it syncs
            if (!edits[newGuest.name]) edits[newGuest.name] = {};
            edits[newGuest.name].isNew = true;
            localStorage.setItem('tyEdits', JSON.stringify(edits));

            showSaveIndicator();
            debouncedSaveToSupabase();
            updateStats();
            renderTable();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderTable();
        }

        let currentEditingGuest = null;

        function showTyNote(name, text) {
            name = name.replace(/&amp;/g, '&');
            currentEditingGuest = name;
            document.getElementById('modalGuestName').textContent = name;
            document.getElementById('modalTyText').value = text || '';
            document.getElementById('tyModal').classList.add('active');
            document.getElementById('modalTyText').focus();
        }

        function saveTyNote() {
            if (currentEditingGuest) {
                const newText = document.getElementById('modalTyText').value;
                saveEdit(currentEditingGuest, 'ty', newText);

                // Update giftData directly
                const idx = giftData.findIndex(g => g.name === currentEditingGuest);
                if (idx !== -1) {
                    giftData[idx].ty = newText;
                }

                renderTable();
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('tyModal').classList.remove('active');
            currentEditingGuest = null;
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterRelation').value = 'all';
            renderTable();
        }

        function markAllEnvelopes() {
            if (confirm('Mark all guests as having envelopes created?')) {
                giftData.forEach(g => {
                    if (!progress[g.name]) progress[g.name] = {};
                    progress[g.name].envelope = true;
                });
                localStorage.setItem('tyProgress', JSON.stringify(progress));
                debouncedSaveToSupabase();
                updateStats();
                renderTable();
            }
        }

        function clearAllProgress() {
            if (confirm('Clear all progress? This cannot be undone.')) {
                progress = {};
                localStorage.setItem('tyProgress', JSON.stringify(progress));
                debouncedSaveToSupabase();
                updateStats();
                renderTable();
            }
        }

        function exportProgress() {
            const data = giftData.map(g => ({
                ...g,
                envelope: getProgress(g.name, 'envelope'),
                written: getProgress(g.name, 'written'),
                sent: getProgress(g.name, 'sent'),
                xmasCard: getProgress(g.name, 'xmasCard')
            }));

            const csv = 'Guest Name,Address,Relation,Gift,Value,TY Note,Envelope Done,Written,Sent,Xmas Card\n' +
                data.map(g => `"${g.name}","${g.address}","${g.relation}","${g.gift}",${g.value},"${(g.ty || '').replace(/"/g, '""')}",${g.envelope},${g.written},${g.sent},${g.xmasCard}`).join('\n');

            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'thank-you-notes-progress.csv';
            a.click();
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterStatus').addEventListener('change', renderTable);
        document.getElementById('filterRelation').addEventListener('change', renderTable);
        document.getElementById('tyModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('tyModal')) closeModal();
        });

        // Initialize
        async function init() {
            try {
                console.log('=== INIT START ===');
                console.log('syncEnabled:', syncEnabled);
                console.log('edits BEFORE load:', Object.keys(edits).length, 'keys');

                // Show/hide setup instructions based on Supabase config
                if (!syncEnabled) {
                    document.getElementById('setupBanner').style.display = 'block';
                } else {
                    document.getElementById('setupInstructions').style.display = 'none';
                }

                // Try to load from Supabase first
                if (syncEnabled) {
                    console.log('Calling loadFromSupabase...');
                    const loadResult = await loadFromSupabase();
                    console.log('loadFromSupabase returned:', loadResult);
                }

                console.log('edits AFTER load:', Object.keys(edits).length, 'keys');
                console.log('Calling applyEdits...');
                applyEdits();

                // Verify a specific guest after applyEdits
                const alecGuest = giftData.find(g => g.name.includes('Alec'));
                if (alecGuest) {
                    console.log('After applyEdits - Alec guest relation:', alecGuest.relation);
                }

                updateStats();
                renderTable();
                console.log('=== INIT COMPLETE ===');
            } catch (e) {
                console.error('Init error:', e);
                // Still try to render with local data
                applyEdits();
                updateStats();
                renderTable();
            }
        }

        init();
    </script>
</body>
</html>
